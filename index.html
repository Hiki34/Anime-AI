<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–ª—å—Ç-–¥–µ–≤–æ—á–∫–∞ ‚Äî –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç</title>
  <style>
    :root{
      --bg1:#06070b;
      --bg2:#121035;
      --card:rgba(20,24,40,.72);
      --card2:rgba(22,26,44,.55);
      --stroke:rgba(255,255,255,.10);
      --text:#e9ecff;
      --muted:rgba(233,236,255,.65);
      --accent:#b176ff;
      --ok:#23d18b;
      --warn:#ffd166;
      --danger:#ff5b5b;
      --shadow:0 30px 80px rgba(0,0,0,.55);
      --radius:20px;
      --radius2:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1000px 700px at 25% 20%, rgba(42,90,45,.35), transparent 60%),
        radial-gradient(900px 650px at 75% 65%, rgba(120,52,180,.35), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{max-width:1180px;margin:0 auto;padding:22px 18px 34px}

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:18px;
      margin-bottom:14px;
    }

    .title{
      display:flex;align-items:center;gap:10px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent);box-shadow:0 0 20px rgba(177,118,255,.65)}

    .subtitle{font-size:12px;color:var(--muted);margin-top:4px}

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      min-width:240px;
      justify-content:center;
    }
    .led{width:10px;height:10px;border-radius:99px;background:rgba(255,255,255,.2)}
    .led.ok{background:var(--ok);box-shadow:0 0 18px rgba(35,209,139,.5)}
    .led.bad{background:var(--danger);box-shadow:0 0 18px rgba(255,91,91,.45)}

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      align-items:stretch;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
      .statusPill{min-width:auto;width:100%}
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .stage{
      min-height:680px;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .stageVisual{
      flex:1;
      min-height:520px;
      display:flex;
      flex-direction:column;
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.06));
      overflow:hidden;
    }

    /* –í—å—é–ø–æ—Ä—Ç –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ‚Äî —á—Ç–æ–±—ã –Ω–µ "—É–µ–∑–∂–∞–ª–∞" –∏ –≤—Å–µ–≥–¥–∞ –≤–ª–µ–∑–∞–ª–∞ */
    .girlViewport{
      position:relative;
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px 10px;
      overflow:hidden;
      min-height:520px;
    }
    #girl{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      max-width:95%;
      max-height:100%;
      width:auto;
      height:auto;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,.5));
      user-select:none;
      pointer-events:none;
    }

    .stageBar{
      border-top:1px solid rgba(255,255,255,.07);
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:space-between;
      background:rgba(0,0,0,.18);
    }

    .bubbleSmall{
      max-width:75%;
      padding:10px 12px;
      border-radius:18px;
      background:rgba(177,118,255,.18);
      border:1px solid rgba(177,118,255,.28);
      color:rgba(233,236,255,.95);
      font-size:14px;
      line-height:1.25;
      white-space:pre-wrap;
    }

    .panel{
      min-height:680px;
      display:flex;
      flex-direction:column;
    }

    .panelTop{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.14);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .btnRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:600;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18)}
    button:active{transform:translateY(1px)}

    .btnOk{border-color:rgba(35,209,139,.35)}
    .btnOk:hover{background:rgba(35,209,139,.10)}

    .btnWarn{border-color:rgba(255,209,102,.35)}
    .btnWarn:hover{background:rgba(255,209,102,.12)}

    .btnDanger{border-color:rgba(255,91,91,.35)}
    .btnDanger:hover{background:rgba(255,91,91,.10)}

    .panelBody{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
      flex:1;
    }

    .section{
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius2);
      background:var(--card2);
      overflow:hidden;
    }

    .sectionHead{
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      background:rgba(0,0,0,.16);
      border-bottom:1px solid rgba(255,255,255,.06);
      color:rgba(233,236,255,.9);
      font-weight:700;
      font-size:13px;
    }

    .sectionContent{padding:12px;display:none;gap:10px;flex-direction:column}
    .section.open .sectionContent{display:flex}

    label{font-size:12px;color:var(--muted)}
    select,input[type="text"],input[type="range"]{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 980px){ .row{grid-template-columns:1fr} }

    .msg{display:flex;flex-direction:column;gap:4px}
    .meta{font-size:11px;color:rgba(233,236,255,.55)}
    .bubble{
      display:inline-block;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      max-width:85%;
      white-space:pre-wrap;
      line-height:1.28;
      font-size:14px;
    }
    .bubble.user{margin-left:auto;background:rgba(35,209,139,.10);border-color:rgba(35,209,139,.20)}
    .bubble.bot{margin-right:auto;background:rgba(177,118,255,.12);border-color:rgba(177,118,255,.18)}

    .inputRow{
      display:flex;gap:8px;align-items:center;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.14);
    }
    .inputRow input{flex:1}

    .hint{font-size:12px;color:rgba(233,236,255,.55);line-height:1.3}

    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:11px; padding:2px 6px; border:1px solid rgba(255,255,255,.14); border-radius:8px; background:rgba(0,0,0,.22)}

    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.5);
      color:rgba(233,236,255,.92);
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      max-width:min(460px, calc(100vw - 28px));
      display:none;
      z-index:50;
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:rgba(233,236,255,.86);
      font-size:12px;
    }

    .switch{
      display:flex;align-items:center;gap:10px;
      font-size:12px;color:rgba(233,236,255,.78)
    }
    .switch input{width:18px;height:18px}

    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title"><span class="dot"></span> –ê–ª—å—Ç-–¥–µ–≤–æ—á–∫–∞</div>
        <div class="subtitle">–≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç ¬∑ Cloudflare Workers AI</div>
      </div>
      <div class="statusPill" id="statusPill">
        <span class="led" id="led"></span>
        <span id="statusText">–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: –ø–µ—Ä—Å–æ–Ω–∞–∂ + –º–∏–Ω–∏-—Ä–µ–ø–ª–∏–∫–∞ -->
      <div class="card">
        <div class="stage">
          <div class="stageVisual">
            <div class="girlViewport">
              <img id="girl" alt="anime girl" src="./gril1.png" />
            </div>
            <div class="stageBar">
              <span class="pill">–æ–Ω–∞</span>
              <div class="bubbleSmall" id="stageBubble">–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: —á–∞—Ç + –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
      <div class="card panel">
        <div class="panelTop">
          <div class="btnRow">
            <button class="btnOk" id="micBtn" title="–†–µ—á—å -> —Ç–µ–∫—Å—Ç">üéô –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
            <button id="stopVoiceBtn" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–∑–≤—É—á–∫—É">‚èπ –°—Ç–æ–ø –≥–æ–ª–æ—Å</button>
            <button class="btnOk" id="healthBtn" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /health">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
            <button class="btnWarn" id="clearBtn">üßπ –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
          </div>
          <div class="pill mono" id="modePill">—Ä–µ–∂–∏–º: —Ç–µ–∫—Å—Ç</div>
        </div>

        <div class="panelBody" id="chatBody">
          <div class="section open" id="settingsSection">
            <div class="sectionHead" id="settingsHead">
              <span>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (Workers AI, –≥–æ–ª–æ—Å, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)</span>
              <span class="mono" id="settingsChevron">‚ñæ</span>
            </div>
            <div class="sectionContent">
              <div>
                <label>Worker base URL</label>
                <input id="apiBase" type="text" value="https://girl-chat.sadreevuz.workers.dev" />
              </div>

              <div class="row">
                <div>
                  <label>–û–∑–≤—É—á–∫–∞</label>
                  <select id="ttsMode">
                    <option value="on" selected>–í–∫–ª—é—á–µ–Ω–∞</option>
                    <option value="off">–í—ã–∫–ª—é—á–µ–Ω–∞</option>
                  </select>
                </div>
                <div>
                  <label>–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</label>
                  <select id="sttLang">
                    <option value="ru-RU" selected>ru-RU</option>
                    <option value="en-US">en-US</option>
                    <option value="ja-JP">ja-JP</option>
                  </select>
                </div>
              </div>

              <div>
                <label>–ì–æ–ª–æ—Å (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞/–û–°)</label>
                <select id="voiceSelect"></select>
              </div>

              <div class="row">
                <div>
                  <label>–¢–µ–º–±—Ä (pitch)</label>
                  <input id="pitch" type="range" min="0.7" max="1.5" step="0.05" value="1.15" />
                </div>
                <div>
                  <label>–°–∫–æ—Ä–æ—Å—Ç—å (rate)</label>
                  <input id="rate" type="range" min="0.7" max="1.3" step="0.05" value="1.0" />
                </div>
              </div>

              <div class="switch">
                <input type="checkbox" id="autoSendVoice" checked />
                <label for="autoSendVoice">–ü–æ—Å–ª–µ –¥–∏–∫—Ç–æ–≤–∫–∏ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
              </div>

              <div class="hint">
                –ï—Å–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –≤–∫–ª—é—á–∏—Ç—Å—è –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≤–æ—Ä–∫–µ—Ä ‚Üí Whisper STT.
              </div>
            </div>
          </div>

          <div class="section open" id="logSection">
            <div class="sectionHead" id="logHead">
              <span>üß™ –õ–æ–≥–∏</span>
              <span class="mono" id="logChevron">‚ñæ</span>
            </div>
            <div class="sectionContent" id="logBox" style="gap:8px"></div>
          </div>

          <div class="section" id="chatSection">
            <div class="sectionHead" id="chatHead">
              <span>üí¨ –ß–∞—Ç</span>
              <span class="mono" id="chatChevron">‚ñ∏</span>
            </div>
            <div class="sectionContent" style="display:flex" id="messagesBox"></div>
          </div>
        </div>

        <div class="inputRow">
          <input id="msgInput" type="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶ (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)" />
          <button class="btnOk" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div style="padding:0 14px 14px">
          <div class="hint">
            –ï—Å–ª–∏ –¥–∏–∫—Ç–æ–≤–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –ø—Ä–æ–≤–µ—Ä—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω. –î–ª—è Firefox –≤–µ–±-—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ —á–∞—Å—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // -------------------- UI helpers --------------------
    const $ = (id) => document.getElementById(id);

    const statusPill = $("statusPill");
    const led = $("led");
    const statusText = $("statusText");
    const modePill = $("modePill");

    const apiBaseEl = $("apiBase");
    const sttLangEl = $("sttLang");
    const ttsModeEl = $("ttsMode");
    const voiceSelectEl = $("voiceSelect");
    const pitchEl = $("pitch");
    const rateEl = $("rate");
    const autoSendVoiceEl = $("autoSendVoice");

    const micBtn = $("micBtn");
    const stopVoiceBtn = $("stopVoiceBtn");
    const healthBtn = $("healthBtn");
    const clearBtn = $("clearBtn");

    const msgInput = $("msgInput");
    const sendBtn = $("sendBtn");

    const stageBubble = $("stageBubble");
    const girlImg = $("girl");

    const logBox = $("logBox");
    const toast = $("toast");
    const messagesBox = $("messagesBox");

    function log(line){
      const el = document.createElement('div');
      el.className = 'hint';
      el.textContent = line;
      logBox.prepend(el);
    }

    let toastTimer = null;
    function showToast(text){
      toast.textContent = text;
      toast.style.display = 'block';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { toast.style.display = 'none'; }, 2400);
    }

    function toggleSection(sectionId){
      const section = $(sectionId);
      section.classList.toggle('open');
      const chevron = section.querySelector('.sectionHead + .sectionContent') ? section.querySelector('.sectionHead').nextElementSibling : null;
    }

    function makeSectionToggle(sectionId, headId, chevronId){
      const section = $(sectionId);
      const head = $(headId);
      const chev = $(chevronId);
      head.addEventListener('click', () => {
        section.classList.toggle('open');
        const isOpen = section.classList.contains('open');
        chev.textContent = isOpen ? '‚ñæ' : '‚ñ∏';
      });
    }

    makeSectionToggle('settingsSection','settingsHead','settingsChevron');
    makeSectionToggle('logSection','logHead','logChevron');
    makeSectionToggle('chatSection','chatHead','chatChevron');

    // -------------------- Chat state ("–æ–±—É—á–µ–Ω–∏–µ" –∫–∞–∫ –ø–∞–º—è—Ç—å —Å–µ—Å—Å–∏–∏) --------------------
    const STORAGE_KEY = 'altgirl.chat.v2';
    let history = [];

    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)){
          history = parsed
            .filter(m => m && (m.role === 'user' || m.role === 'assistant') && typeof m.content === 'string')
            .slice(-30);
        }
      }catch{}
    }

    function saveHistory(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(history.slice(-30))); }catch{}
    }

    function renderHistory(){
      messagesBox.innerHTML = '';
      for (const m of history){
        addMsg(m.role === 'user' ? '–¢—ã' : '–æ–Ω–∞', m.content, m.role === 'user' ? 'user' : 'bot', false);
      }
      // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
      messagesBox.parentElement.scrollTop = messagesBox.parentElement.scrollHeight;
    }

    function pushHistory(role, content){
      history.push({ role, content });
      if (history.length > 30) history.shift();
      saveHistory();
    }

    function addMsg(who, text, cls, alsoStage = true){
      const wrap = document.createElement('div');
      wrap.className = 'msg';

      const meta = document.createElement('div');
      meta.className = 'meta';
      const t = new Date();
      const hh = String(t.getHours()).padStart(2,'0');
      const mm = String(t.getMinutes()).padStart(2,'0');
      const ss = String(t.getSeconds()).padStart(2,'0');
      meta.textContent = `${who} ¬∑ ${hh}:${mm}:${ss}`;

      const bub = document.createElement('div');
      bub.className = 'bubble ' + (cls || '');
      bub.textContent = text;

      wrap.appendChild(meta);
      wrap.appendChild(bub);
      messagesBox.appendChild(wrap);
      messagesBox.parentElement.scrollTop = messagesBox.parentElement.scrollHeight;

      if (alsoStage && cls === 'bot'){
        stageBubble.textContent = text;
      }
      if (cls === 'bot'){
        // —Å–º–µ–Ω–∞ —ç–º–æ—Ü–∏–∏ –ø–æ —Ç–µ–∫—Å—Ç—É (–ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
        const lower = text.toLowerCase();
        const excited = lower.includes('!') || lower.includes('—Ö–∞') || lower.includes('—Ö–∞—Ö–∞') || lower.includes('—ç–º–æ–¥–∑–∏') || lower.includes('üòÑ') || lower.includes('‚ú®');
        girlImg.src = excited ? './gril2.png' : './gril1.png';
      }
    }

    // -------------------- Network --------------------
    function apiBase(){
      return (apiBaseEl.value || '').trim().replace(/\/$/,'');
    }

    async function checkHealth(){
      const base = apiBase();
      if (!base){
        setStatus(false, '–ù–µ—Ç URL');
        return;
      }
      try{
        const r = await fetch(base + '/health', { method:'GET' });
        const data = await r.json().catch(()=> ({}));
        const ok = r.ok && data && data.ok === true;
        setStatus(ok, ok ? '–ì–æ—Ç–æ–≤–æ.' : '–û—à–∏–±–∫–∞ /health');
        log(`health: HTTP ${r.status} ${ok ? 'ok' : 'fail'}`);
      }catch(e){
        setStatus(false, '–ù–µ—Ç —Å–≤—è–∑–∏');
        log('health error: ' + (e && e.message ? e.message : String(e)));
      }
    }

    function setStatus(ok, text){
      statusText.textContent = text;
      led.classList.remove('ok','bad');
      led.classList.add(ok ? 'ok' : 'bad');
    }

    // -------------------- TTS (–±—Ä–∞—É–∑–µ—Ä) --------------------
    let voiceReady = false;
    let allVoices = [];

    function rebuildVoiceList(){
      allVoices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
      voiceSelectEl.innerHTML = '';

      const optAuto = document.createElement('option');
      optAuto.value = '__auto__';
      optAuto.textContent = '–ê–≤—Ç–æ (–ª—É—á—à–∏–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π)';
      voiceSelectEl.appendChild(optAuto);

      for (const v of allVoices){
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelectEl.appendChild(opt);
      }

      voiceReady = true;
    }

    function pickVoice(){
      if (!voiceReady) rebuildVoiceList();
      const selected = voiceSelectEl.value;
      const lang = sttLangEl.value || 'ru-RU';

      if (selected && selected !== '__auto__'){
        return allVoices.find(v => v.name === selected) || null;
      }

      // –ê–≤—Ç–æ–≤—ã–±–æ—Ä: —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≥–æ–ª–æ—Å –ø–æ —è–∑—ã–∫—É
      const exact = allVoices.find(v => (v.lang || '').toLowerCase() === lang.toLowerCase());
      if (exact) return exact;

      const byPrefix = allVoices.find(v => (v.lang || '').toLowerCase().startsWith(lang.split('-')[0].toLowerCase()));
      if (byPrefix) return byPrefix;

      return allVoices[0] || null;
    }

    function stopSpeaking(){
      try{ speechSynthesis.cancel(); }catch{}
    }

    function speak(text){
      if (ttsModeEl.value !== 'on') return;
      if (!('speechSynthesis' in window)) return;

      stopSpeaking();

      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice();
      if (v) u.voice = v;
      u.lang = sttLangEl.value || 'ru-RU';
      u.pitch = parseFloat(pitchEl.value || '1');
      u.rate = parseFloat(rateEl.value || '1');
      u.volume = 1;

      speechSynthesis.speak(u);
    }

    stopVoiceBtn.addEventListener('click', () => {
      stopSpeaking();
      showToast('–û–∑–≤—É—á–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    });

    if ('speechSynthesis' in window){
      speechSynthesis.onvoiceschanged = () => rebuildVoiceList();
      // –∏–Ω–æ–≥–¥–∞ —Å–ø–∏—Å–æ–∫ –≥–æ—Ç–æ–≤ —Å—Ä–∞–∑—É
      setTimeout(() => rebuildVoiceList(), 200);
    } else {
      voiceSelectEl.innerHTML = '<option value="__auto__">TTS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</option>';
    }

    // -------------------- STT (–º–∏–∫—Ä–æ—Ñ–æ–Ω) --------------------
    // 1) –µ—Å–ª–∏ –µ—Å—Ç—å SpeechRecognition ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    // 2) –∏–Ω–∞—á–µ: MediaRecorder -> /stt (Whisper)

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;

    let recording = false;
    let recorder = null;
    let recStream = null;
    let recChunks = [];

    function setMicState(active){
      recording = active;
      micBtn.textContent = active ? 'üõë –°—Ç–æ–ø –¥–∏–∫—Ç–æ–≤–∫–∞' : 'üéô –ú–∏–∫—Ä–æ—Ñ–æ–Ω';
      modePill.textContent = active ? '—Ä–µ–∂–∏–º: —Å–ª—É—à–∞—é‚Ä¶' : '—Ä–µ–∂–∏–º: —Ç–µ–∫—Å—Ç';
      micBtn.classList.toggle('btnDanger', active);
      micBtn.classList.toggle('btnOk', !active);
    }

    async function blobToBase64(blob){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('FileReader error'));
        reader.onload = () => {
          const res = String(reader.result || '');
          const comma = res.indexOf(',');
          resolve(comma >= 0 ? res.slice(comma + 1) : res);
        };
        reader.readAsDataURL(blob);
      });
    }

    function extractTextFromSTT(res){
      if (!res) return '';
      if (typeof res.text === 'string') return res.text;
      if (res.result && typeof res.result.text === 'string') return res.result.text;
      if (typeof res.transcript === 'string') return res.transcript;
      return '';
    }

    async function sttViaWorker(audioB64){
      const base = apiBase();
      const r = await fetch(base + '/stt', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ audio: audioB64 }),
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data && data.error ? data.error : ('STT HTTP ' + r.status));
      return extractTextFromSTT(data);
    }

    async function startRecorder(){
      recChunks = [];
      recStream = await navigator.mediaDevices.getUserMedia({ audio:true });

      const preferredTypes = [
        'audio/webm;codecs=opus',
        'audio/webm',
        'audio/ogg;codecs=opus',
        'audio/ogg'
      ];
      let mime = '';
      for (const t of preferredTypes){
        if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) { mime = t; break; }
      }

      recorder = new MediaRecorder(recStream, mime ? { mimeType: mime } : undefined);

      recorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) recChunks.push(e.data);
      };

      recorder.onstop = async () => {
        try{
          const blob = new Blob(recChunks, { type: recorder.mimeType || 'audio/webm' });
          const b64 = await blobToBase64(blob);
          showToast('–†–∞—Å–ø–æ–∑–Ω–∞—é‚Ä¶');
          const text = await sttViaWorker(b64);
          if (text){
            msgInput.value = text;
            log('stt ok: ' + text);
            if (autoSendVoiceEl.checked){
              await sendChat(text);
            } else {
              showToast('–¢–µ–∫—Å—Ç –≥–æ—Ç–æ–≤ (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω)');
            }
          } else {
            showToast('–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ');
          }
        }catch(e){
          log('stt error: ' + (e && e.message ? e.message : String(e)));
          showToast('STT –æ—à–∏–±–∫–∞');
        } finally {
          try{ recStream.getTracks().forEach(t => t.stop()); }catch{}
          recStream = null;
          recorder = null;
          recChunks = [];
        }
      };

      recorder.start();
    }

    async function startDictation(){
      const lang = sttLangEl.value || 'ru-RU';

      if (SpeechRecognition){
        recognition = new SpeechRecognition();
        recognition.lang = lang;
        recognition.interimResults = true;
        recognition.continuous = false;

        let finalText = '';

        recognition.onresult = (event) => {
          let interim = '';
          for (let i = event.resultIndex; i < event.results.length; i++){
            const part = event.results[i][0].transcript;
            if (event.results[i].isFinal) finalText += part;
            else interim += part;
          }
          const current = (finalText + ' ' + interim).trim();
          if (current) msgInput.value = current;
        };

        recognition.onerror = (e) => {
          log('SpeechRecognition error: ' + (e && e.error ? e.error : 'unknown'));
          showToast('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (–±—Ä–∞—É–∑–µ—Ä) –æ—à–∏–±–∫–∞');
          stopDictation();
        };

        recognition.onend = async () => {
          setMicState(false);
          const text = (msgInput.value || '').trim();
          if (text && autoSendVoiceEl.checked){
            await sendChat(text);
          }
        };

        recognition.start();
        setMicState(true);
        modePill.textContent = '—Ä–µ–∂–∏–º: —Å–ª—É—à–∞—é (–±—Ä–∞—É–∑–µ—Ä)‚Ä¶';
        return;
      }

      // Fallback: MediaRecorder -> Worker STT
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder){
        showToast('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        log('No getUserMedia / MediaRecorder');
        return;
      }

      await startRecorder();
      setMicState(true);
      modePill.textContent = '—Ä–µ–∂–∏–º: —Å–ª—É—à–∞—é (Whisper)‚Ä¶';
    }

    function stopDictation(){
      if (recognition){
        try{ recognition.stop(); }catch{}
        recognition = null;
        setMicState(false);
        return;
      }
      if (recorder && recorder.state !== 'inactive'){
        try{ recorder.stop(); }catch{}
      }
      setMicState(false);
    }

    micBtn.addEventListener('click', async () => {
      if (recording){
        stopDictation();
        return;
      }
      try{
        await startDictation();
      }catch(e){
        log('mic start error: ' + (e && e.message ? e.message : String(e)));
        showToast('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
        setMicState(false);
      }
    });

    // -------------------- Chat call --------------------
    function extractAssistantText(res){
      if (!res) return '';
      // Workers AI –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: { response: "..." }
      if (typeof res.response === 'string') return res.response;
      // –∏–ª–∏: { result: { response: "..." } }
      if (res.result && typeof res.result.response === 'string') return res.result.response;
      // –∏–ª–∏: OpenAI-like: { choices:[{message:{content}}] }
      const c = res.choices && res.choices[0] && res.choices[0].message && res.choices[0].message.content;
      if (typeof c === 'string') return c;
      // fallback
      if (typeof res.text === 'string') return res.text;
      return '';
    }

    async function sendChat(text){
      const base = apiBase();
      const content = (text || '').trim();
      if (!content) return;

      addMsg('–¢—ã', content, 'user', false);
      pushHistory('user', content);

      // —Å—Ç—Ä–æ–∏–º messages –¥–ª—è –≤–æ—Ä–∫–µ—Ä–∞ (–ø–∞–º—è—Ç—å)
      const messages = history.slice(-24).map(m => ({ role: m.role, content: m.content }));

      try{
        const r = await fetch(base + '/chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ messages }),
        });
        const data = await r.json().catch(()=> ({}));
        if (!r.ok){
          const err = data && data.error ? data.error : ('HTTP ' + r.status);
          addMsg('—Å–∏—Å—Ç–µ–º–∞', err, 'bot');
          log('chat error: ' + err);
          return;
        }

        const answer = extractAssistantText(data) || '‚Ä¶';
        addMsg('–æ–Ω–∞', answer, 'bot');
        pushHistory('assistant', answer);
        speak(answer);

      }catch(e){
        const err = e && e.message ? e.message : String(e);
        addMsg('—Å–∏—Å—Ç–µ–º–∞', err, 'bot');
        log('chat fetch error: ' + err);
      }
    }

    sendBtn.addEventListener('click', () => {
      const t = msgInput.value;
      msgInput.value = '';
      sendChat(t);
    });

    msgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        sendBtn.click();
      }
    });

    clearBtn.addEventListener('click', () => {
      history = [];
      saveHistory();
      renderHistory();
      stageBubble.textContent = '–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ü–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å :)';
      showToast('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
    });

    healthBtn.addEventListener('click', () => checkHealth());

    // -------------------- Init --------------------
    loadHistory();
    renderHistory();
    checkHealth();

    log('–ì–æ—Ç–æ–≤–æ. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–æ—Ä–∫–µ—Ä—É, –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤—å —Å–æ–æ–±—â–µ–Ω–∏–µ.');
  </script>
</body>
</html>
