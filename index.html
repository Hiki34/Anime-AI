<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–ª—å—Ç‚Äë–¥–µ–≤–æ—á–∫–∞ ‚Äî –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç (Cloudflare Workers AI)</title>
  <style>
    :root{
      --bg1:#0b0b12;
      --bg2:#0f1220;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.55);
      --good:#2bdc74;
      --bad:#ff4d4d;
      --warn:#f5c542;
      --accent:#a855f7;
      --accent2:#22d3ee;
      --shadow: 0 14px 60px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:var(--font);
      background:
        radial-gradient(900px 600px at 20% 20%, rgba(34,211,238,.16), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(168,85,247,.16), transparent 60%),
        radial-gradient(1000px 800px at 50% 80%, rgba(43,220,116,.08), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 40px;}

    .header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
      margin-bottom:14px;
    }

    .title{
      display:flex;align-items:center;gap:10px;
      font-weight:800;letter-spacing:.2px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 0 3px rgba(168,85,247,.18);
    }
    .subtitle{margin-top:2px;color:var(--muted);font-size:13px;}

    .statusPill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      min-width:260px;
      justify-content:space-between;
    }
    .statusLeft{display:flex;align-items:center;gap:10px}
    .led{width:10px;height:10px;border-radius:999px;background:var(--muted2)}
    .led.good{background:var(--good); box-shadow:0 0 0 3px rgba(43,220,116,.16)}
    .led.bad{background:var(--bad); box-shadow:0 0 0 3px rgba(255,77,77,.16)}
    .statusText{font-size:13px;color:var(--muted)}

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .95fr;
      gap:18px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
      .statusPill{min-width:unset; width:100%;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      backdrop-filter: blur(10px);
    }

    /* LEFT: character stage */
    .stage{
      padding:18px;
      min-height:680px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .girlWrap{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.08));
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      padding:14px 10px;
      height: 600px; /* –≤–∞–∂–Ω–æ: —á—Ç–æ–±—ã –≤—Å—è —Ñ–∏–≥—É—Ä–∞ –ø–æ–º–µ—â–∞–ª–∞—Å—å */
    }

    #girl{
      height:100%;
      max-height: 100%;
      width:auto;
      max-width:95%;
      object-fit:contain;
      filter: drop-shadow(0 18px 44px rgba(0,0,0,.55));
      transform: translateY(0);
      user-select:none;
      pointer-events:none;
    }

    .stageBar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }

    .bubbleStage{
      padding:12px 14px;
      border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:14px;
      min-height:46px;
      display:flex;align-items:center;
    }

    /* RIGHT: chat */
    .chat{
      padding:16px;
      min-height:680px;
      display:flex;flex-direction:column;
      gap:12px;
    }

    .topRow{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}

    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      font-weight:650;
      font-size:13px;
    }
    .btn:hover{background:rgba(0,0,0,.32);border-color:rgba(255,255,255,.18)}
    .btn:active{transform:translateY(1px)}
    .btn.green{border-color:rgba(43,220,116,.32)}
    .btn.red{border-color:rgba(255,77,77,.32)}
    .btn.purple{border-color:rgba(168,85,247,.32)}

    .toggle{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      font-size:13px;
      color:var(--muted);
      user-select:none;
    }
    .toggle input{accent-color: var(--good);}

    .settings{
      padding:12px 12px;
      border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .settings summary{cursor:pointer;color:var(--muted);font-weight:700;}
    .settingsGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .field{display:flex;flex-direction:column;gap:6px;}
    .label{font-size:12px;color:var(--muted)}
    .input, select{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr; gap:10px;}
    @media(max-width:520px){.row2{grid-template-columns:1fr;}}

    .chatArea{
      flex:1;
      overflow:auto;
      padding:8px 4px 8px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .msg{
      max-width: 92%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      line-height:1.25;
      font-size:14px;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .msg.me{
      margin-left:auto;
      background: rgba(34,211,238,.10);
      border-color: rgba(34,211,238,.18);
    }
    .msg.her{
      margin-right:auto;
      background: rgba(168,85,247,.10);
      border-color: rgba(168,85,247,.18);
    }

    .meta{font-size:11px;color:rgba(255,255,255,.45);margin-bottom:4px;}

    .composer{
      display:flex;gap:10px;align-items:center;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .sendBtn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(43,220,116,.28);
      background: rgba(43,220,116,.10);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
    }

    .hint{color:var(--muted2);font-size:12px;line-height:1.35;}

    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; padding:1px 6px; border-radius:8px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.75);
    }

    .pillMini{display:inline-flex;align-items:center;gap:6px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); font-size:12px; color:var(--muted);
    }

    /* scrollbars */
    .chatArea::-webkit-scrollbar{height:10px;width:10px}
    .chatArea::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    .chatArea::-webkit-scrollbar-track{background:rgba(0,0,0,.12)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title"><span class="dot"></span><div>
          <div style="font-size:18px">–ê–ª—å—Ç‚Äë–¥–µ–≤–æ—á–∫–∞</div>
          <div class="subtitle">–≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç ¬∑ Cloudflare Workers AI</div>
        </div></div>
      </div>

      <div class="statusPill" id="statusPill">
        <div class="statusLeft">
          <span class="led" id="led"></span>
          <span class="statusText" id="statusText">–ì–æ—Ç–æ–≤–æ.</span>
        </div>
        <span class="pillMini" id="netInfo">‚Äî</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <section class="card stage">
        <div class="girlWrap" aria-label="–î–µ–≤–æ—á–∫–∞">
          <img id="girl" src="gril1.png" alt="–ê–Ω–∏–º–µ‚Äë–¥–µ–≤–æ—á–∫–∞" />
        </div>
        <div class="stageBar">
          <div class="bubbleStage" id="stageBubble">‚Ä¶</div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card chat">
        <div class="topRow">
          <button class="btn green" id="micBtn">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
          <button class="btn red" id="stopSpeechBtn" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–∑–≤—É—á–∫—É">üîá –°—Ç–æ–ø –≥–æ–ª–æ—Å</button>
          <button class="btn purple" id="healthBtn">üü¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
          <label class="toggle" title="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî –ø–æ—Å–ª–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Å–∞–º–æ">
            <input type="checkbox" id="autoSendStt" checked /> –∞–≤—Ç–æ‚Äë–æ—Ç–ø—Ä–∞–≤–∫–∞
          </label>
          <button class="btn" id="clearBtn">üßπ –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
        </div>

        <details class="settings">
          <summary>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (Workers AI, –≥–æ–ª–æ—Å, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)</summary>
          <div class="settingsGrid">
            <div class="field">
              <div class="label">Worker base URL (–±–µ–∑ /chat). –ü—Ä–∏–º–µ—Ä: <span class="kbd">https://girl-chat.sadreevuz.workers.dev</span></div>
              <input class="input" id="workerBase" placeholder="https://...workers.dev" />
            </div>

            <div class="row2">
              <div class="field">
                <div class="label">–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (STT)</div>
                <select id="sttLang">
                  <option value="ru-RU">ru‚ÄëRU</option>
                  <option value="en-US">en‚ÄëUS</option>
                  <option value="ja-JP">ja‚ÄëJP</option>
                </select>
              </div>
              <div class="field">
                <div class="label">–ì–æ–ª–æ—Å –æ–∑–≤—É—á–∫–∏ (TTS, –±—Ä–∞—É–∑–µ—Ä)</div>
                <select id="voiceSelect"></select>
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <div class="label">–°–∫–æ—Ä–æ—Å—Ç—å –æ–∑–≤—É—á–∫–∏</div>
                <input class="input" id="rate" type="range" min="0.7" max="1.4" step="0.05" value="1.05" />
              </div>
              <div class="field">
                <div class="label">–í—ã—Å–æ—Ç–∞ –≥–æ–ª–æ—Å–∞</div>
                <input class="input" id="pitch" type="range" min="0.8" max="1.7" step="0.05" value="1.25" />
              </div>
            </div>

            <div class="hint" id="diagHint">
              –ï—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω ‚Äú—Å–ª—É—à–∞–µ—Ç‚Äù, –Ω–æ —Ç–µ–∫—Å—Ç –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è ‚Äî —ç—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ:
              1) –Ω–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ <span class="kbd">SpeechRecognition</span> (–≤ Firefox –æ–±—ã—á–Ω–æ –Ω–µ—Ç),
              2) –Ω–µ –≤—ã–¥–∞–Ω –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É,
              3) –≤—ã–±—Ä–∞–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —è–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è.
            </div>
          </div>
        </details>

        <div class="chatArea" id="chatArea" aria-label="–ß–∞—Ç"></div>

        <div class="composer">
          <input class="input" id="msgInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶ (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)" />
          <button class="sendBtn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div class="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –º–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Ä–µ—á—å –∏ –∫–ª–∞–¥—ë—Ç —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ <span class="kbd">–∏</span> (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ‚Äë–æ—Ç–ø—Ä–∞–≤–∫–∞) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∞–º.</div>
      </section>
    </div>
  </div>

<script>
(() => {
  // --------- DOM
  const led = document.getElementById('led');
  const statusText = document.getElementById('statusText');
  const netInfo = document.getElementById('netInfo');
  const stageBubble = document.getElementById('stageBubble');
  const girl = document.getElementById('girl');

  const micBtn = document.getElementById('micBtn');
  const stopSpeechBtn = document.getElementById('stopSpeechBtn');
  const healthBtn = document.getElementById('healthBtn');
  const clearBtn = document.getElementById('clearBtn');
  const autoSendStt = document.getElementById('autoSendStt');

  const workerBase = document.getElementById('workerBase');
  const sttLang = document.getElementById('sttLang');
  const voiceSelect = document.getElementById('voiceSelect');
  const rate = document.getElementById('rate');
  const pitch = document.getElementById('pitch');

  const chatArea = document.getElementById('chatArea');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');

  // --------- state
  const LS_SETTINGS = 'altgirl_settings_v2';
  const LS_CHAT = 'altgirl_chat_v1';

  let isConnected = false;
  let isListening = false;
  let recognition = null;
  let finalTranscript = '';

  let chat = []; // {role:'user'|'assistant', content:string, ts:number}

  // --------- helpers
  const nowHHMMSS = () => new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});

  function setStatus(text, mode = 'neutral'){
    statusText.textContent = text;
    led.classList.remove('good','bad');
    if (mode === 'good') led.classList.add('good');
    if (mode === 'bad') led.classList.add('bad');
  }

  function safeBase(url){
    return (url || '').trim().replace(/\/+$/, '');
  }

  function addBubble(who, text, ts){
    const wrap = document.createElement('div');

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = `${who === 'me' ? '—Ç—ã' : '–æ–Ω–∞'} ¬∑ ${ts || nowHHMMSS()}`;

    const bubble = document.createElement('div');
    bubble.className = `msg ${who === 'me' ? 'me' : 'her'}`;
    bubble.textContent = text;

    wrap.appendChild(meta);
    wrap.appendChild(bubble);
    chatArea.appendChild(wrap);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function persistChat(){
    try{
      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ user/assistant
      const trimmed = chat.slice(-60).map(m => ({ role:m.role, content:m.content, ts:m.ts }));
      localStorage.setItem(LS_CHAT, JSON.stringify(trimmed));
    }catch{}
  }

  function loadChat(){
    try{
      const raw = localStorage.getItem(LS_CHAT);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return;
      chat = parsed.filter(m => m && (m.role === 'user' || m.role === 'assistant') && typeof m.content === 'string');
    }catch{}
  }

  function renderChat(){
    chatArea.innerHTML = '';
    for (const m of chat){
      addBubble(m.role === 'user' ? 'me' : 'her', m.content, m.ts ? new Date(m.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : undefined);
    }
    // –ø–æ—Å–ª–µ–¥–Ω—è—è —Ñ—Ä–∞–∑–∞ –Ω–∞ —Å—Ü–µ–Ω—É
    const last = [...chat].reverse().find(m => m.role === 'assistant');
    if (last) stageBubble.textContent = last.content;
  }

  function setGirlTalking(isTalking){
    girl.src = isTalking ? 'gril2.png' : 'gril1.png';
  }

  function speak(text){
    if (!('speechSynthesis' in window)){
      setStatus('–û–∑–≤—É—á–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.', 'bad');
      return;
    }
    window.speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = Number(rate.value || 1.0);
    utter.pitch = Number(pitch.value || 1.0);

    const voices = window.speechSynthesis.getVoices();
    const chosen = voices.find(v => v.name === voiceSelect.value);
    if (chosen) utter.voice = chosen;

    utter.onstart = () => { setGirlTalking(true); };
    utter.onend = () => { setGirlTalking(false); };
    utter.onerror = () => { setGirlTalking(false); };

    window.speechSynthesis.speak(utter);
  }

  function listVoices(){
    const voices = window.speechSynthesis?.getVoices?.() || [];
    voiceSelect.innerHTML = '';

    // –≥—Ä—É–ø–ø–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ ru, –ø–æ—Ç–æ–º ja, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ
    const sorted = [...voices].sort((a,b) => {
      const score = (v) => (v.lang?.startsWith('ru') ? 0 : v.lang?.startsWith('ja') ? 1 : 2);
      return score(a) - score(b) || a.name.localeCompare(b.name);
    });

    for (const v of sorted){
      const opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSelect.appendChild(opt);
    }

    // –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –≥–æ–ª–æ—Å: —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π -> ru -> ja -> –ø–µ—Ä–≤—ã–π
    const saved = loadSettings().voiceName;
    if (saved && sorted.some(v => v.name === saved)){
      voiceSelect.value = saved;
      return;
    }

    const ru = sorted.find(v => v.lang?.startsWith('ru'));
    const ja = sorted.find(v => v.lang?.startsWith('ja'));
    const pick = ru || ja || sorted[0];
    if (pick) voiceSelect.value = pick.name;
  }

  function saveSettings(){
    try{
      const payload = {
        workerBase: safeBase(workerBase.value),
        sttLang: sttLang.value,
        voiceName: voiceSelect.value,
        rate: rate.value,
        pitch: pitch.value,
        autoSendStt: autoSendStt.checked
      };
      localStorage.setItem(LS_SETTINGS, JSON.stringify(payload));
    }catch{}
  }

  function loadSettings(){
    try{
      const raw = localStorage.getItem(LS_SETTINGS);
      if (!raw) return {};
      return JSON.parse(raw) || {};
    }catch{ return {}; }
  }

  function applySettings(){
    const s = loadSettings();
    workerBase.value = s.workerBase || 'https://girl-chat.sadreevuz.workers.dev';
    sttLang.value = s.sttLang || 'ru-RU';
    rate.value = s.rate || '1.05';
    pitch.value = s.pitch || '1.25';
    autoSendStt.checked = (typeof s.autoSendStt === 'boolean') ? s.autoSendStt : true;
  }

  async function checkHealth(){
    const base = safeBase(workerBase.value);
    if (!base){
      setStatus('–£–∫–∞–∂–∏ Worker base URL.', 'bad');
      isConnected = false;
      netInfo.textContent = '‚Äî';
      return false;
    }

    setStatus('–ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶');
    const t0 = performance.now();
    try{
      const res = await fetch(base + '/health', { method:'GET' });
      const ms = Math.round(performance.now() - t0);
      netInfo.textContent = `ping ${ms}ms`;

      if (!res.ok){
        setStatus(`API –æ—à–∏–±–∫–∞: ${res.status}`, 'bad');
        isConnected = false;
        return false;
      }
      const data = await res.json().catch(() => ({}));
      if (data && data.ok === true){
        setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ.', 'good');
        isConnected = true;
        return true;
      }
      setStatus('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç /health.', 'bad');
      isConnected = false;
      return false;
    }catch(err){
      setStatus('–ù–µ –º–æ–≥—É –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ –≤–æ—Ä–∫–µ—Ä–∞ (CORS/—Å–µ—Ç—å).', 'bad');
      isConnected = false;
      return false;
    }
  }

  async function sendText(text){
    const base = safeBase(workerBase.value);
    if (!base){ setStatus('–£–∫–∞–∂–∏ Worker base URL.', 'bad'); return; }

    const clean = (text || '').trim();
    if (!clean) return;

    addBubble('me', clean);
    chat.push({ role:'user', content: clean, ts: Date.now() });
    persistChat();

    setStatus('–î—É–º–∞—é‚Ä¶');

    // –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const history = chat
      .filter(m => m && (m.role === 'user' || m.role === 'assistant') && typeof m.content === 'string')
      .slice(-14)
      .map(m => ({ role: m.role, content: m.content }));

    const payload = { text: clean, history };

    try{
      const res = await fetch(base + '/chat', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok){
        const raw = await res.text().catch(() => '');
        setStatus(`API –æ—à–∏–±–∫–∞ ${res.status}: ${raw.slice(0,120)}`, 'bad');
        return;
      }

      const data = await res.json();
      // Workers AI –æ–±—ã—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { response: "..." } (–¥–ª—è chat) –∏–ª–∏ –ø–æ—Ö–æ–∂—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
      const answer = (data && (data.response || data.result || data.output || data.text))
        ? String(data.response || data.result || data.output || data.text)
        : JSON.stringify(data);

      addBubble('her', answer);
      stageBubble.textContent = answer;
      chat.push({ role:'assistant', content: answer, ts: Date.now() });
      persistChat();

      setStatus('–ì–æ—Ç–æ–≤–æ.', 'good');

      // –æ–∑–≤—É—á–∫–∞
      speak(answer);

    }catch(e){
      setStatus('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ (—Å–µ—Ç—å/CORS).', 'bad');
    }
  }

  // --------- STT
  function startMic(){
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition){
      setStatus('SpeechRecognition –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.', 'bad');
      return;
    }

    if (isListening){
      try{ recognition?.stop?.(); }catch{}
      return;
    }

    finalTranscript = '';

    recognition = new SpeechRecognition();
    recognition.lang = sttLang.value;
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onstart = () => {
      isListening = true;
      micBtn.textContent = 'üõë –°—Ç–æ–ø –º–∏–∫—Ä–æ—Ñ–æ–Ω';
      setStatus('–°–ª—É—à–∞—é‚Ä¶ –≥–æ–≤–æ—Ä–∏.', 'good');
    };

    recognition.onresult = (event) => {
      let interim = '';
      for (let i = event.resultIndex; i < event.results.length; i++){
        const res = event.results[i];
        const t = res[0]?.transcript || '';
        if (res.isFinal) finalTranscript += t;
        else interim += t;
      }
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä—è–º–æ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      msgInput.value = (finalTranscript + interim).trim();
    };

    recognition.onerror = (e) => {
      // no-speech / not-allowed / audio-capture
      setStatus(`STT –æ—à–∏–±–∫–∞: ${e.error || 'unknown'}`, 'bad');
    };

    recognition.onend = async () => {
      const txt = (finalTranscript || msgInput.value || '').trim();
      isListening = false;
      micBtn.textContent = 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω';

      if (txt){
        setStatus('–†–µ—á—å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞.', 'good');
        if (autoSendStt.checked){
          msgInput.value = '';
          await sendText(txt);
        }
      } else {
        setStatus('–ù–µ —É—Å–ª—ã—à–∞–ª —Ä–µ—á—å. –ü–æ–ø—Ä–æ–±—É–π –±–ª–∏–∂–µ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.', 'bad');
      }
    };

    try{ recognition.start(); }
    catch{ setStatus('–ù–µ –º–æ–≥—É –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω (—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è/–±—Ä–∞—É–∑–µ—Ä).', 'bad'); }
  }

  function stopSpeech(){
    try{ window.speechSynthesis?.cancel?.(); }catch{}
    setGirlTalking(false);
    setStatus('–û–∑–≤—É—á–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.');
  }

  // --------- events
  healthBtn.addEventListener('click', checkHealth);
  micBtn.addEventListener('click', startMic);
  stopSpeechBtn.addEventListener('click', stopSpeech);

  sendBtn.addEventListener('click', () => {
    const t = msgInput.value;
    msgInput.value = '';
    sendText(t);
  });

  msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter'){
      e.preventDefault();
      const t = msgInput.value;
      msgInput.value = '';
      sendText(t);
    }
  });

  clearBtn.addEventListener('click', () => {
    chat = [];
    persistChat();
    chatArea.innerHTML = '';
    stageBubble.textContent = '‚Ä¶';
    setStatus('–ß–∞—Ç –æ—á–∏—â–µ–Ω.');
  });

  for (const el of [workerBase, sttLang, voiceSelect, rate, pitch, autoSendStt]){
    el.addEventListener('change', saveSettings);
    el.addEventListener('input', saveSettings);
  }

  // voices
  if ('speechSynthesis' in window){
    window.speechSynthesis.onvoiceschanged = () => listVoices();
    // –∏–Ω–æ–≥–¥–∞ –≥–æ–ª–æ—Å–∞ –¥–æ—Å—Ç—É–ø–Ω—ã —Å—Ä–∞–∑—É
    setTimeout(listVoices, 200);
  }

  // init
  applySettings();
  loadChat();
  renderChat();

  // –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞
  setTimeout(checkHealth, 350);

  // –ø–µ—Ä–≤–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞
  if (!chat.length){
    stageBubble.textContent = '–ü—Ä–∏–≤–µ—Ç! –Ø —Ç—É—Ç. –ù–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ¬ª, –ø–æ—Ç–æ–º –ø–∏—à–∏ –∏–ª–∏ –≥–æ–≤–æ—Ä–∏ üéß';
  }
})();
</script>
</body>
</html>
