<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–ª—å—Ç‚Äë–¥–µ–≤–æ—á–∫–∞ ‚Äî —á–∞—Ç (Workers AI)</title>
  <style>
    :root{
      --bg:#070812;
      --panel: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.10);
      --txt:#ECECF6;
      --muted: rgba(236,236,246,.72);
      --good:#25d366;
      --bad:#ff4d4d;
      --warn:#ffcc00;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(182,255,46,.12), transparent 55%),
        radial-gradient(1000px 520px at 80% 30%, rgba(255,59,212,.12), transparent 60%),
        radial-gradient(800px 520px at 50% 85%, rgba(110,70,255,.14), transparent 60%),
        var(--bg);
      color:var(--txt);
      font: 14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
      min-height:100vh;
      padding:18px;
    }

    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin:0 auto 14px;
      max-width: 1180px;
    }
    .brand{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,59,212,.85);box-shadow:0 0 18px rgba(255,59,212,.55)}
    .brand b{font-size:16px}
    .brand span{color:var(--muted);font-size:12px}

    .statusPill{
      display:flex;
      gap:10px;
      align-items:center;
      background: var(--panel);
      border: 1px solid var(--stroke);
      padding:10px 12px;
      border-radius: 999px;
      backdrop-filter: blur(10px);
      min-width: 260px;
      justify-content:flex-start;
    }
    .led{width:10px;height:10px;border-radius:999px;background:rgba(236,236,246,.35);box-shadow:none}
    .led.ok{background:var(--good);box-shadow:0 0 18px rgba(37,211,102,.45)}
    .led.bad{background:var(--bad);box-shadow:0 0 18px rgba(255,77,77,.45)}
    .led.busy{background:var(--warn);box-shadow:0 0 18px rgba(255,204,0,.35)}
    .statusPill .txt{color:rgba(236,236,246,.9);font-size:13px}

    main{max-width:1180px;margin:0 auto;display:grid;grid-template-columns: 1.1fr .9fr;gap:14px;align-items:start}

    .stage,.panel{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .stage{
      padding:14px;
      position:relative;
      min-height: 680px;
    }
    .girlWrap{
      display:flex;
      justify-content:center;
      align-items:center;
      height:min(560px, calc(100vh - 220px));
    }
    #girl{
      width:auto;
      max-width:min(460px, 90%);
      height:100%;
      max-height:100%;
      object-fit:contain;
      image-rendering:auto;
      filter: drop-shadow(0 12px 40px rgba(0,0,0,.55));
      transition: transform .12s ease;
      user-select:none;
      pointer-events:none;
    }
    .bubble{
      margin-top: 10px;
      border: 1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 12px;
    }
    .bubble .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color: rgba(236,236,246,.75);
      margin-bottom: 6px;
    }
    .bubble .text{font-size:14px;color:rgba(236,236,246,.92)}
    .muted{color:rgba(236,236,246,.72)}

    .panel{display:flex;flex-direction:column;min-height:680px}

    .panelTop{
      padding:12px;
      display:flex;
      gap:10px;
      border-bottom: 1px solid var(--stroke2);
      flex-wrap:wrap;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
      color: rgba(236,236,246,.92);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(0,0,0,.26)}
    .btn.active{box-shadow:0 0 0 2px rgba(111,249,152,.35) inset;border-color:rgba(111,249,152,.65);}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color: rgba(182,255,46,.28);background: rgba(182,255,46,.10)}
    .btn.danger{border-color: rgba(255,77,77,.28);background: rgba(255,77,77,.08)}

    .panelBody{display:flex;flex-direction:column;flex:1 1 auto}

    details{border-bottom:1px solid var(--stroke2)}
    summary{cursor:pointer;padding:12px;color:rgba(236,236,246,.9);user-select:none}

    .settings{padding:12px;display:grid;gap:10px}
    .grid{display:grid;grid-template-columns: repeat(12, 1fr);gap:10px}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;color:rgba(236,236,246,.75)}
    .field input,.field select{
      width:100%;
      border-radius: 12px;
      padding: 10px 10px;
      border: 1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
      color: rgba(236,236,246,.92);
      outline:none;
    }
    .field input:focus,.field select:focus{border-color: rgba(182,255,46,.35);box-shadow:0 0 0 3px rgba(182,255,46,.10)}

    .inline{display:flex;gap:10px;align-items:center}
    .inline input{width:auto}

    .col12{grid-column: span 12}
    .col6{grid-column: span 6}
    .col4{grid-column: span 4}
    .col3{grid-column: span 3}
    .col2{grid-column: span 2}

    .hint{
      padding:10px 12px;
      border-top:1px solid var(--stroke2);
      color: rgba(236,236,246,.72);
      font-size: 12px;
    }
    .hint b{color: rgba(236,236,246,.9)}
    .hint code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .chat{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      height: 340px;
    }
    .msg{
      max-width: 92%;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg .meta{display:block;font-size:12px;color: rgba(236,236,246,.55);margin-bottom:6px}
    .msg.user{align-self:flex-end;border-color: rgba(182,255,46,.22);background: rgba(182,255,46,.06)}
    .msg.bot{align-self:flex-start;border-color: rgba(255,59,212,.22);background: rgba(255,59,212,.06)}
    .msg.sys{align-self:center;font-size:13px;border-style:dashed;color: rgba(236,236,246,.78)}
    .msg.err{align-self:center;border-color: rgba(255,77,77,.28);background: rgba(255,77,77,.08)}

    .composer{
      display:flex;
      gap:10px;
      padding:12px;
      border-top: 1px solid var(--stroke2);
      align-items:center;
    }
    #textIn{flex:1 1 auto}

    @media (max-width: 920px){
      main{grid-template-columns:1fr}
      .stage,.panel{min-height:auto}
      .girlWrap{height: 480px}
      .chat{height: 280px}
      .statusPill{min-width:unset;width:100%}
      header{flex-direction:column;align-items:stretch}
      .brand{justify-content:space-between}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="dot"></div>
      <div>
        <b>–ê–ª—å—Ç‚Äë–¥–µ–≤–æ—á–∫–∞</b>
        <div><span>–≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç ¬∑ Cloudflare Workers AI</span></div>
      </div>
    </div>

    <div class="statusPill" title="–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —Ä–∞–±–æ—Ç—ã">
      <div class="led" id="led"></div>
      <div class="txt" id="status">–ì–æ—Ç–æ–≤–æ.</div>
    </div>
  </header>

  <main>
    <section class="stage" aria-label="–ü–µ—Ä—Å–æ–Ω–∞–∂">
      <div class="girlWrap">
        <img id="girl" alt="–ü–µ—Ä—Å–æ–Ω–∞–∂" />
      </div>
      <div class="bubble" aria-label="–§—Ä–∞–∑–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
        <div class="tag" id="bubbleTag">–æ–Ω–∞</div>
        <div class="text muted" id="bubbleText">–ù–∞–∂–º–∏ ¬´üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω¬ª, —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å, –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–Ω–∏–∑—É.</div>
      </div>
    </section>

    <section class="panel" aria-label="–ß–∞—Ç –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
      <div class="panelTop">
        <button class="btn primary" id="btnMic">üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
        <button class="btn" id="btnStopTTS">‚èπ –°—Ç–æ–ø –≥–æ–ª–æ—Å</button>
        <button class="btn" id="btnCheck">üü¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        <button class="btn danger" id="btnClear">üßπ –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
      </div>

      <div class="panelBody">
        <details>
          <summary>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (Workers AI, –≥–æ–ª–æ—Å, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)</summary>
          <div class="settings">
            <div class="grid">
              <div class="field col12">
                <label for="workerUrl">URL Cloudflare Worker</label>
                <input id="workerUrl" type="text" placeholder="https://<–∏–º—è>.workers.dev" />
              </div>

              <div class="field col6">
                <label for="voiceSelect">–ì–æ–ª–æ—Å –æ–∑–≤—É—á–∫–∏ (—Å–∏—Å—Ç–µ–º–Ω—ã–π)</label>
                <select id="voiceSelect"></select>
              </div>
              <div class="field col3">
                <label for="pitch">Pitch</label>
                <input id="pitch" type="range" min="0" max="2" step="0.05" value="1.20" />
              </div>
              <div class="field col3">
                <label for="rate">Rate</label>
                <input id="rate" type="range" min="0.1" max="2" step="0.05" value="1.05" />
              </div>

              <div class="field col12">
                <div class="row">
                  <button class="btn" type="button" id="btnAnimeVoice">üéÄ –ê–Ω–∏–º–µ‚Äë—Ä–µ–∂–∏–º</button>
                  <button class="btn" type="button" id="btnPreviewVoice">‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä –≥–æ–ª–æ—Å–∞</button>
                </div>
                <div class="microhint" id="voiceHint">–ì–æ–ª–æ—Å–∞ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ.</div>
              </div>

              <div class="field col6 inline">
                <input id="enableTTS" type="checkbox" checked />
                <label for="enableTTS">–û–∑–≤—É—á–∏–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã</label>
              </div>
              <div class="field col6 inline">
                <input id="showDebug" type="checkbox" />
                <label for="showDebug">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏</label>
              </div>
            </div>

            <div class="hint" id="envHint"></div>
          </div>
        </details>

        <div class="chat" id="chat" role="log" aria-label="–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π"></div>

        <div class="composer" aria-label="–í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è">
          <input id="textIn" type="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶ (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)" />
          <button class="btn primary" id="btnSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div class="hint">
          –ï—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: —á–∞—â–µ –≤—Å–µ–≥–æ —ç—Ç–æ <b>Firefox</b> (–Ω–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Speech API –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏) –∏–ª–∏ –∑–∞–ø—Ä–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.
        </div>
      </div>
    </section>
  </main>

<script>
(function(){
  // ===============================
  // 0) –†–µ—Å—É—Ä—Å—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
  // ===============================
  // –ü–æ–ª–æ–∂–∏ —Ä—è–¥–æ–º —Å index.html —Ñ–∞–π–ª—ã: gril1.png –∏ gril2.png
  const GIRL_IDLE_SRC = "gril1.png";
  const GIRL_TALK_SRC = "gril2.png";

  // ===============================
  // 1) DOM
  // ===============================
  const el = (id) => document.getElementById(id);
  const chatEl = el("chat");
  const statusEl = el("status");
  const ledEl = el("led");
  const bubbleTextEl = el("bubbleText");
  const envHintEl = el("envHint");
  const girlImg = el("girl");

  const btnMic = el("btnMic");
  const btnStopTTS = el("btnStopTTS");
  const btnCheck = el("btnCheck");
  const btnClear = el("btnClear");
  const btnSend = el("btnSend");

  const inputText = el("textIn");
  const inputWorkerUrl = el("workerUrl");
  const voiceSelect = el("voiceSelect");
  const pitchEl = el("pitch");
  const rateEl = el("rate");
  const enableTTSEl = el("enableTTS");
  const showDebugEl = el("showDebug");

  const btnAnimeVoice = el("btnAnimeVoice");
  const btnPreviewVoice = el("btnPreviewVoice");
  const voiceHintEl = el("voiceHint");

  // ===============================
  // 2) –°–æ—Å—Ç–æ—è–Ω–∏–µ
  // ===============================
  const LS = {
    workerUrl: "altGirl_workerUrl",
    enableTTS: "altGirl_enableTTS",
    pitch: "altGirl_pitch",
    rate: "altGirl_rate",
    voiceURI: "altGirl_voiceURI",
    showDebug: "altGirl_showDebug",
  };

  let busy = false;
  let micOn = false;
  let recognizer = null;
  let lastWorkerOk = null;

  const convo = []; // {role:'user'|'assistant', content:string}

  function nowTime(){
    const d = new Date();
    return d.toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  }

  function normalizeBase(url){
    const u = (url || "").trim();
    if(!u) return "";
    return u.replace(/\/+$/, "");
  }

  function getWorkerBase(){
    return normalizeBase(inputWorkerUrl.value);
  }

  function setLed(state){
    ledEl.classList.remove("ok","bad","busy");
    if(state) ledEl.classList.add(state);
  }

  function setStatus(text, level="neutral"){
    statusEl.textContent = text;
    if(level === "ok") setLed("ok");
    else if(level === "bad") setLed("bad");
    else if(level === "busy") setLed("busy");
    else setLed(null);
  }

  function setGirl(mode){
    // mode: 'idle' | 'talk'
    girlImg.src = (mode === "talk") ? GIRL_TALK_SRC : GIRL_IDLE_SRC;
  }

  function pushMsg(kind, who, text){
    const wrap = document.createElement("div");
    wrap.className = "msg " + kind;
    const meta = document.createElement("span");
    meta.className = "meta";
    meta.textContent = `${who} ¬∑ ${nowTime()}`;
    const body = document.createElement("div");
    body.textContent = text;
    wrap.appendChild(meta);
    wrap.appendChild(body);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function sys(text){ pushMsg("sys","—Å–∏—Å—Ç–µ–º–∞", text); }
  function err(text){ pushMsg("err","–æ—à–∏–±–∫–∞", text); }

  function bubble(text, muted=false){
    bubbleTextEl.textContent = text;
    bubbleTextEl.classList.toggle("muted", !!muted);
  }

  // ===============================
  // 3) TTS
  // ===============================
  let ttsUtter = null;

  function stopTTS(){
    try{ speechSynthesis.cancel(); }catch(_){ }
    ttsUtter = null;
    setGirl("idle");
  }

  function updateVoiceHint(){
    try{
      const v = getSelectedVoice();
      const list = speechSynthesis.getVoices() || [];
      if(!voiceHintEl) return;
      if(!list.length){ voiceHintEl.textContent = "–°–ø–∏—Å–æ–∫ –≥–æ–ª–æ—Å–æ–≤ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶"; return; }
      if(!v){ voiceHintEl.textContent = `–ì–æ–ª–æ—Å–∞: ${list.length}. –í—ã–±—Ä–∞–Ω –≥–æ–ª–æ—Å: (–Ω–µ –≤—ã–±—Ä–∞–Ω)`; return; }
      voiceHintEl.textContent = `–ì–æ–ª–æ—Å–∞: ${list.length}. –í—ã–±—Ä–∞–Ω: ${v.name} (${v.lang})`;
    }catch(_){ /* ignore */ }
  }

  function pickAnimeVoice(force=false){
    // –í –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞ ¬´–∞–Ω–∏–º–µ‚Äë–≥–æ–ª–æ—Å–∞¬ª. –ú—ã –≤—ã–±–∏—Ä–∞–µ–º —Å–∞–º—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤.
    const list = speechSynthesis.getVoices() || [];
    if(!list.length) return false;
    const saved = localStorage.getItem(LS.voiceURI);
    if(!force && saved) return false;

    const ru = list.filter(v => (v.lang||"" ).toLowerCase().startsWith("ru"));
    const hints = /(irina|tatyana|oksana|anna|maria|alena|katya|daria|vera|olga|yandex|google|microsoft|–∂–µ–Ω|female)/i;
    const pick = (arr) => arr.find(v => hints.test(v.name)) || arr[0];
    let v = pick(ru) || pick(list);

    if(v){
      voiceSelect.value = v.voiceURI;
      localStorage.setItem(LS.voiceURI, v.voiceURI);
      // ¬´–ú–∏–ª–µ–µ¬ª –∑–∞ —Å—á—ë—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –Ω–æ –±–µ–∑ —Å–∏–ª—å–Ω–æ–≥–æ –∏—Å–∫–∞–∂–µ–Ω–∏—è
      pitchEl.value = String(1.18);
      rateEl.value = String(1.05);
      localStorage.setItem(LS.pitch, pitchEl.value);
      localStorage.setItem(LS.rate, rateEl.value);
      updateTTSLabels();
      updateVoiceHint();
      return true;
    }
    return false;
  }

  function previewVoice(){
    if(!enableTTSEl.checked){
      sys("–í–∫–ª—é—á–∏ –æ–∑–≤—É—á–∫—É (TTS), —á—Ç–æ–±—ã –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –≥–æ–ª–æ—Å.");
      return;
    }
    speakText("–ü—Ä–∏–≤–µ—Ç! –Ø –ê–ª—å—Ç-–¥–µ–≤–æ—á–∫–∞. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?");
  }

  function getSelectedVoice(){
    const uri = voiceSelect.value;
    const list = speechSynthesis.getVoices();
    return list.find(v => v.voiceURI === uri) || null;
  }

  function speak(text){
    if(!enableTTSEl.checked) return;
    if(!("speechSynthesis" in window)) return;

    stopTTS();

    const u = new SpeechSynthesisUtterance(text);
    const v = getSelectedVoice();
    if(v) u.voice = v;

    u.lang = "ru-RU";
    u.pitch = Number(pitchEl.value || 1);
    u.rate  = Number(rateEl.value  || 1);

    u.onstart = () => { setGirl("talk"); };
    u.onend = () => { setGirl("idle"); };
    u.onerror = () => { setGirl("idle"); };

    ttsUtter = u;
    speechSynthesis.speak(u);
  }

  function populateVoices(){
    const list = speechSynthesis.getVoices();
    const saved = localStorage.getItem(LS.voiceURI) || "";

    voiceSelect.innerHTML = "";

    // –°–Ω–∞—á–∞–ª–∞ —Ä—É—Å—Å–∫–∏–µ, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    const ru = list.filter(v => (v.lang||"").toLowerCase().startsWith("ru"));
    const other = list.filter(v => !ru.includes(v));
    const ordered = [...ru, ...other];

    for(const v of ordered){
      const opt = document.createElement("option");
      opt.value = v.voiceURI;
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSelect.appendChild(opt);
    }

    if(saved && ordered.some(v => v.voiceURI === saved)){
      voiceSelect.value = saved;
    } else if(ru.length){
      voiceSelect.value = ru[0].voiceURI;
    } else if(ordered.length){
      voiceSelect.value = ordered[0].voiceURI;
    }

    if(!saved){
      pickAnimeVoice(false);
    }
    updateVoiceHint();
  }

  // ===============================
  // 4) Workers AI –∑–∞–ø—Ä–æ—Å
  // ===============================
  function extractAnswer(json){
    // Cloudflare Workers AI –æ—Ç–≤–µ—Ç—ã –º–æ–≥—É—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –ø–æ‚Äë—Ä–∞–∑–Ω–æ–º—É (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥–µ–ª–∏/–≤–µ—Ä—Å–∏–∏)
    if(typeof json === "string") return json;

    if(json && typeof json === "object"){
      if(typeof json.response === "string") return json.response;
      if(json.result && typeof json.result.response === "string") return json.result.response;
      if(json.result && typeof json.result.text === "string") return json.result.text;
      if(typeof json.output_text === "string") return json.output_text;

      // OpenAI‚Äë–ø–æ–¥–æ–±–Ω—ã–µ —Ñ–æ—Ä–º—ã (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
      const c0 = json.choices && json.choices[0];
      const m0 = c0 && c0.message && c0.message.content;
      if(typeof m0 === "string") return m0;
    }

    try{ return JSON.stringify(json); }catch(_){ return "(–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç)"; }
  }

  async function callWorker(text){
    const base = getWorkerBase();
    if(!base){
      throw new Error("–ù–µ –∑–∞–¥–∞–Ω URL –≤–æ—Ä–∫–µ—Ä–∞.");
    }

    const url = base + "/chat";
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    const ct = (r.headers.get("content-type") || "").toLowerCase();
    const raw = ct.includes("application/json") ? await r.json() : await r.text();

    if(!r.ok){
      const details = (typeof raw === "string") ? raw : (showDebugEl.checked ? JSON.stringify(raw) : "" );
      throw new Error(`HTTP ${r.status}: ${details || "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞"}`);
    }

    return raw;
  }

  async function checkWorker(){
    const base = getWorkerBase();
    if(!base){
      setStatus("–£–∫–∞–∂–∏ URL –≤–æ—Ä–∫–µ—Ä–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.", "bad");
      lastWorkerOk = false;
      return false;
    }

    setStatus("–ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶", "busy");

    try{
      const r = await fetch(base + "/health", { method: "GET" });
      const ct = (r.headers.get("content-type") || "").toLowerCase();
      const data = ct.includes("application/json") ? await r.json() : await r.text();

      const ok = r.ok && ((data && data.ok === true) || (typeof data === "string" && data.toLowerCase().includes("ok")));

      if(ok){
        setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚úÖ", "ok");
        lastWorkerOk = true;
        return true;
      }

      setStatus(`–ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ ‚ùå (HTTP ${r.status})`, "bad");
      if(showDebugEl.checked){
        sys("–ü—Ä–æ–≤–µ—Ä–∫–∞ /health: " + (typeof data === "string" ? data : JSON.stringify(data)));
      }
      lastWorkerOk = false;
      return false;

    }catch(e){
      setStatus("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚ùå", "bad");
      if(showDebugEl.checked){
        err(String(e && e.message ? e.message : e));
      }
      lastWorkerOk = false;
      return false;
    }
  }

  // ===============================
  // 5) –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  // ===============================
  async function sendText(text){
    const msg = (text || "").trim();
    if(!msg) return;
    if(busy) return;

    stopTTS();
    busy = true;
    setStatus("–î—É–º–∞—é‚Ä¶", "busy");
    setGirl("talk");

    pushMsg("user", "—Ç—ã", msg);
    bubble("‚Ä¶", true);

    convo.push({ role: "user", content: msg });

    try{
      const raw = await callWorker(msg);
      const answer = extractAnswer(raw);

      convo.push({ role: "assistant", content: answer });

      pushMsg("bot", "–æ–Ω–∞", answer);
      bubble(answer, false);

      setStatus("–ì–æ—Ç–æ–≤–æ.", lastWorkerOk === false ? "neutral" : "ok");
      speak(answer);

      if(showDebugEl.checked && raw && typeof raw === "object"){
        sys("RAW JSON: " + JSON.stringify(raw));
      }

    }catch(e){
      const m = String(e && e.message ? e.message : e);
      err(m);
      bubble("–£–ø—Å‚Ä¶ —É –º–µ–Ω—è –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.", false);
      setStatus("–û—à–∏–±–∫–∞ ‚ùå", "bad");
      setGirl("idle");
    } finally {
      busy = false;
    }
  }

  // ===============================
  // 6) STT (–º–∏–∫—Ä–æ—Ñ–æ–Ω)
  // ===============================
  function setupSTT(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      envHintEl.innerHTML = '<b>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏:</b> –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π Chrome/Edge –∏–ª–∏ –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞.';
      btnMic.disabled = true;
      return;
    }

    recognizer = new SR();
    recognizer.lang = 'ru-RU';
    recognizer.interimResults = true;
    recognizer.continuous = false;
    recognizer.maxAlternatives = 1;

    let sttGotFinal = false;
    let sttLastError = '';

    recognizer.onstart = () => {
      sttGotFinal = false;
      sttLastError = '';
      micOn = true;
      stopTTS();
      setGirl('talk');
      btnMic.classList.add('active');
      btnMic.textContent = 'üéôÔ∏è –°–ª—É—à–∞—é‚Ä¶ (–∫–ª–∏–∫ = —Å—Ç–æ–ø)';
      setStatus('–°–ª—É—à–∞—é‚Ä¶', 'busy');
    };

    recognizer.onend = () => {
      micOn = false;
      btnMic.classList.remove('active');
      btnMic.textContent = 'üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω';
      setGirl('idle');
      if(!sttGotFinal && !sttLastError){
        sys('–ù–∏—á–µ–≥–æ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–æ—Å—å. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∏ –ø–æ–ø—Ä–æ–±—É–π –≥–æ–≤–æ—Ä–∏—Ç—å –±–ª–∏–∂–µ/–≥—Ä–æ–º—á–µ.');
      }
      setStatus('–ì–æ—Ç–æ–≤–æ.', lastWorkerOk ? 'ok' : 'neutral');
    };

    recognizer.onerror = (ev) => {
      sttLastError = (ev && ev.error) ? ev.error : 'unknown';
      micOn = false;
      btnMic.classList.remove('active');
      btnMic.textContent = 'üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω';
      setGirl('idle');
      setStatus('STT –æ—à–∏–±–∫–∞ ‚ùå', 'bad');

      const map = {
        'no-speech': '–ù–µ —É—Å–ª—ã—à–∞–ª —Ä–µ—á—å (no-speech).',
        'audio-capture': '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (audio-capture).',
        'not-allowed': '–ó–∞–ø—Ä–µ—â—ë–Ω –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É (not-allowed).',
        'service-not-allowed': '–°–µ—Ä–≤–∏—Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (service-not-allowed).'
      };
      sys((map[sttLastError] || ('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ' + sttLastError)) + ' –ï—Å–ª–∏ —Ç—ã –≤ Firefox ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è.');
      if(showDebugEl.checked){
        err('STT error: ' + sttLastError);
      }
    };

    recognizer.onresult = (ev) => {
      try{
        let interim = '';
        let final = '';
        for(let i=ev.resultIndex; i<ev.results.length; i++){
          const res = ev.results[i];
          const txt = (res && res[0] && res[0].transcript) ? res[0].transcript : '';
          if(res.isFinal) final += txt;
          else interim += txt;
        }

        if(interim && interim.trim()){
          inputText.value = interim.trim();
        }
        if(final && final.trim()){
          sttGotFinal = true;
          inputText.value = final.trim();
          sendText(final.trim());
        }
      }catch(_){ }
    };

    envHintEl.innerHTML = '<b>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</b> –î–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –Ω—É–∂–µ–Ω –±—Ä–∞—É–∑–µ—Ä —Å Web Speech API. URL –≤–æ—Ä–∫–µ—Ä–∞ –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ <code>/health</code> –∏ <code>/chat</code>.';
  }

  function toggleMic(){
    if(!recognizer) return;
    if(micOn){
      try{ recognizer.stop(); }catch(_){ }
      return;
    }
    try{ recognizer.start(); }catch(e){
      sys('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω. –ü—Ä–æ–≤–µ—Ä—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.');
      if(showDebugEl.checked){
        err('STT start error: ' + (e && e.message ? e.message : 'unknown'));
      }
    }
  }

  // ===============================
  // 7) –°–æ–±—ã—Ç–∏—è UI
  // ===============================
  btnMic.addEventListener("click", toggleMic);
  btnStopTTS.addEventListener("click", stopTTS);

  btnSend.addEventListener("click", () => sendText(inputText.value));
  inputText.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      sendText(inputText.value);
    }
  });

  btnClear.addEventListener("click", () => {
    stopTTS();
    chatEl.innerHTML = "";
    convo.length = 0;
    bubble("–ß–∞—Ç –æ—á–∏—â–µ–Ω.", true);
    sys("–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.");
  });

  btnCheck.addEventListener("click", checkWorker);

  // persist settings
  inputWorkerUrl.addEventListener("change", () => {
    localStorage.setItem(LS.workerUrl, inputWorkerUrl.value);
  });
  enableTTSEl.addEventListener("change", () => localStorage.setItem(LS.enableTTS, enableTTSEl.checked ? "1" : "0"));
  pitchEl.addEventListener("change", () => localStorage.setItem(LS.pitch, String(pitchEl.value)));
  rateEl.addEventListener("change", () => localStorage.setItem(LS.rate, String(rateEl.value)));
  voiceSelect.addEventListener("change", () => {
    localStorage.setItem(LS.voiceURI, voiceSelect.value);
    updateVoiceHint();
  });

  btnAnimeVoice?.addEventListener("click", () => {
    const v = pickAnimeVoice(true);
    updateVoiceHint();
    sys(v ? ("–ê–Ω–∏–º–µ‚Äë—Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω: " + v.name + " (" + v.lang + ").") : "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –≥–æ–ª–æ—Å: –±—Ä–∞—É–∑–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Å–ø–∏—Å–æ–∫ –≥–æ–ª–æ—Å–æ–≤.");
  });

  btnPreviewVoice?.addEventListener("click", () => previewVoice());
  showDebugEl.addEventListener("change", () => localStorage.setItem(LS.showDebug, showDebugEl.checked ? "1" : "0"));

  // ===============================
  // 8) Init
  // ===============================
  function init(){
    setGirl("idle");

    // default worker from your screenshots
    const defWorker = "https://girl-chat.sadreevuz.workers.dev";

    inputWorkerUrl.value = localStorage.getItem(LS.workerUrl) || defWorker;
    enableTTSEl.checked = (localStorage.getItem(LS.enableTTS) ?? "1") === "1";
    showDebugEl.checked = (localStorage.getItem(LS.showDebug) ?? "0") === "1";

    const savedPitch = localStorage.getItem(LS.pitch);
    const savedRate = localStorage.getItem(LS.rate);
    if(savedPitch) pitchEl.value = savedPitch;
    if(savedRate) rateEl.value = savedRate;

    if("speechSynthesis" in window){
      populateVoices();
      speechSynthesis.onvoiceschanged = populateVoices;
    } else {
      enableTTSEl.checked = false;
      enableTTSEl.disabled = true;
    }

    setupSTT();

    sys("–ì–æ—Ç–æ–≤–æ. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–æ—Ä–∫–µ—Ä—É, –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤—å —Å–æ–æ–±—â–µ–Ω–∏–µ.");

    // –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
    checkWorker();
  }

  init();

})();
</script>
</body>
</html>
